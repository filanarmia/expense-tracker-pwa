<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>Add Expense</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="back-btn" title="Back">â†</a>
        <h1>Add Expense</h1>
        <button id="theme-toggle" class="icon-btn" title="Toggle theme">ğŸŒ™</button>
      </div>
    </header>

    <!-- Add Form -->
    <div class="form-container">
      <form id="expense-form">
        <div class="form-group">
          <label for="amount">Amount (RM)</label>
          <input type="number" id="amount" step="0.01" min="0" required 
                 placeholder="0.00" autocomplete="off">
        </div>

        <div class="form-group">
          <label for="note">Note (optional)</label>
          <input type="text" id="note" placeholder="What did you buy?" 
                 autocomplete="off">
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" required>
            <option value="">Select category</option>
          </select>
        </div>

        <div class="form-group">
          <label for="custom-category">Add Custom Category</label>
          <div class="custom-category-input">
            <input type="text" id="custom-category" placeholder="New category name">
            <button type="button" id="add-category-btn">Add</button>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="primary-btn">Save Expense</button>
          <a href="index.html" class="secondary-btn">Cancel</a>
        </div>
      </form>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="message success" style="display: none;">
      âœ… Expense saved successfully!
    </div>

    <!-- Error Message -->
    <div id="error-message" class="message error" style="display: none;">
      âŒ Failed to save expense. Please try again.
    </div>
  </div>

  <!-- Scripts -->
  <script src="storage.js"></script>
  
  <script>
    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await storage.init();
        await loadTheme();
        await loadCategories();
        setupEventListeners();
        
        // Focus on amount input
        document.getElementById('amount').focus();
      } catch (error) {
        console.error('Failed to initialize app:', error);
        showError('Failed to initialize app');
      }
    });

    // Load categories into dropdown
    async function loadCategories() {
      try {
        const categories = await storage.getCategories();
        const select = document.getElementById('category');
        
        // Clear existing options (except first one)
        while (select.children.length > 1) {
          select.removeChild(select.lastChild);
        }
        
        // Add categories
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load categories:', error);
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Form submission
      document.getElementById('expense-form').addEventListener('submit', handleFormSubmit);

      // Add custom category
      document.getElementById('add-category-btn').addEventListener('click', handleAddCategory);

      // Theme toggle
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

      // Auto-hide messages
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');

      // Number input formatting
      const amountInput = document.getElementById('amount');
      amountInput.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        if (!isNaN(value)) {
          e.target.value = value.toFixed(2);
        }
      });

      // Enter key navigation
      document.getElementById('amount').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('note').focus();
        }
      });

      document.getElementById('note').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('category').focus();
        }
      });
    }

    // Handle form submission
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const amount = document.getElementById('amount').value;
      const note = document.getElementById('note').value;
      const category = document.getElementById('category').value;

      if (!amount || !category) {
        showError('Amount and category are required');
        return;
      }

      try {
        await storage.addExpense(amount, note, category);
        showSuccess('Expense saved successfully!');
        
        // Reset form
        document.getElementById('expense-form').reset();
        document.getElementById('amount').focus();
        
        // Auto-redirect after 1 second
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
        
      } catch (error) {
        console.error('Failed to save expense:', error);
        showError('Failed to save expense. Please try again.');
      }
    }

    // Handle adding custom category
    async function handleAddCategory() {
      const customCategory = document.getElementById('custom-category').value.trim();
      
      if (!customCategory) {
        showError('Please enter a category name');
        return;
      }

      try {
        await storage.addCategory(customCategory);
        await loadCategories();
        
        // Select the newly added category
        document.getElementById('category').value = customCategory;
        document.getElementById('custom-category').value = '';
        
        showSuccess('Category added successfully!');
      } catch (error) {
        console.error('Failed to add category:', error);
        if (error.name === 'ConstraintError') {
          showError('Category already exists');
        } else {
          showError('Failed to add category');
        }
      }
    }

    // Show success message
    function showSuccess(message) {
      const element = document.getElementById('success-message');
      element.textContent = 'âœ… ' + message;
      element.style.display = 'block';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    // Show error message
    function showError(message) {
      const element = document.getElementById('error-message');
      element.textContent = 'âŒ ' + message;
      element.style.display = 'block';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    // Theme management
    async function loadTheme() {
      const theme = await storage.getTheme();
      document.body.className = theme;
      document.getElementById('theme-toggle').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    async function toggleTheme() {
      const currentTheme = document.body.className;
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.body.className = newTheme;
      document.getElementById('theme-toggle').textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      
      await storage.setTheme(newTheme);
    }
  </script>
</body>
</html>
